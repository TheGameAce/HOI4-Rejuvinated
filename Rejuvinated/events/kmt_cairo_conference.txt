add_namespace = cairoC

#cairoC
country_event = {
	id = cairoC.1
	title = cairoC.1.t
	desc = cairoC.1.d
	picture = GFX_report_event_generic_sign_treaty1

	trigger = {
		tag = USA
		has_war_with = JAP
		ENG = {
			has_war_with = JAP
			NOT = {
				has_government = fascism
			}
			is_puppet = no
			is_major = yes
			has_country_leader = {
				character = ENG_winston_churchill
				ruling_only = yes
			}
		}
		event_target:KMT_central_gov_tag = {
			has_war_with = JAP
			NOT = {
				has_government = fascism
			}
			is_puppet = no
			is_major = yes
			is_faction_leader = yes
		}
		has_government = democratic
		is_puppet = no
		JAP = {
			has_government = fascism
		}
		is_major = yes
	}
	
	is_triggered_only = yes
	
	#mean_time_to_happen = { days = 90 }
	
	fire_only_once = yes
	
	option = {
		ai_chance = { factor = 100 }
		name = cairoC.1.a
		set_variable = { global.USA_cairoC_responded = 0 }
		event_target:KMT_central_gov_tag = {
			country_event = { id = cairoC.2 hours = 3 }
		}
		ENG = {
			country_event = { id = cairoC.2 hours = 1 }
		}
	}
	
	option = {
		name = cairoC.1.b
	}
}

#cairoC invitation
country_event = {
	id = cairoC.2
	title = cairoC.2.t
	desc = {
		text = cairoC.2.d
		trigger = { tag = ENG }
	}
	desc = {
		text = cairoC.2.d_2
		trigger = { tag = event_target:KMT_central_gov_tag }
	}
	picture = GFX_report_event_generic_sign_treaty1

	is_triggered_only = yes
	
	option = {
		ai_chance = { 
			factor = 100 
			modifier = { 
				tag = ENG
				factor = 0.8
			}
		}
		name = cairoC.2.a
		if = {
			limit = {
				tag = event_target:KMT_central_gov_tag
			}
			set_global_flag = CHI_atten_cairoC
		}
		if = {
			limit = {
				tag = ENG
			}
			set_global_flag = ENG_atten_cairoC
		}
		if = {
			limit = {
				NOT = {
					has_global_flag = someone_attend_cairoC
				}
			}
			set_global_flag = someone_attend_cairoC
		}
		add_to_variable = { global.USA_cairoC_responded = 1 }
		FROM = {
			country_event = { id = cairoC.3 }
		}
	}
	
	option = {
		ai_chance = { 
			factor = 0
			modifier = { 
				tag = ENG
				factor = 20
			}
		}
		name = cairoC.2.b
		add_to_variable = { global.USA_cairoC_responded = 1 }
		FROM = {
			country_event = { id = cairoC.4 }
		}
	}
}

#cairoC invitation - yes
country_event = {
	id = cairoC.3
	title = cairoC.3.t
	desc = cairoC.3.d
	picture = GFX_report_event_generic_sign_treaty1

	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				check_variable = { global.USA_cairoC_responded > 1 }
				has_global_flag = someone_attend_cairoC
			}
			hidden_effect = {
				country_event = { id = cairoC.5 hours = 2 }
			}
		}
	}
	
	option = {
		name = cairoC.3.a
	}
}

#cairoC invitation - no
country_event = {
	id = cairoC.4
	title = cairoC.4.t
	desc = cairoC.4.d
	picture = GFX_report_event_generic_sign_treaty1

	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				check_variable = { global.USA_cairoC_responded > 1 }
				has_global_flag = someone_attend_cairoC
			}
			hidden_effect = {
				country_event = { id = cairoC.5 hours = 2 }
			}
		}
	}
	
	option = {
		name = cairoC.4.a
	}
}

#cairoC terms
country_event = {
	id = cairoC.5
	title = cairoC.5.t
	desc = cairoC.5.d
	picture = GFX_report_event_generic_sign_treaty1

	is_triggered_only = yes
	
	immediate = {
		effect_tooltip = {
			if = {
				limit = {
					has_global_flag = CHI_atten_cairoC
				}
				event_target:KMT_central_gov_tag = {
					if = {
						limit = {
							has_global_flag = ENG_atten_cairoC
						}
						add_political_power = 500
						else = {
							add_political_power = 200
						}
					}
					add_war_support = 0.3
					custom_effect_tooltip = KMT_no_seperate_peace_with_JAP
					add_equipment_to_stockpile = { type = convoy_1 amount = 2000 producer = USA }
					custom_effect_tooltip = KMT_war_with_axis_tt
					every_country = {
						limit = {
							OR = {
								has_war_with = ENG
								has_war_with = USA
							}
						}
						every_country = {
							limit = {
								OR = {
									tag = event_target:KMT_central_gov_tag
									is_subject_of = event_target:KMT_central_gov_tag
									is_in_faction_with = event_target:KMT_central_gov_tag
								}
							}
							declare_war_on = {
								target = PREV
								type = topple_government
							}
						}
					}
				}
			}
			if = {
				limit = {
					has_global_flag = ENG_atten_cairoC
				}
				ENG = {
					if = {
						limit = {
							has_global_flag = CHI_atten_cairoC
						}
						add_political_power = -50
					}
					add_tech_bonus = {
						uses = 2
						bonus = 2
						category = naval_equipment
					}
					add_equipment_to_stockpile = { type = convoy_1 amount = 1000 producer = ENG }
				}
			}
			USA = {
				if = {
					limit = {
						has_global_flag = CHI_atten_cairoC
					}
					add_political_power = -50
				}
				if = {
					limit = {
						has_global_flag = ENG_atten_cairoC
					}
					add_tech_bonus = {
						uses = 2
						bonus = 2
						category = naval_equipment
					}
					add_tech_bonus = {
						uses = 2
						bonus = 2
						category = tp_tech
					}
					add_equipment_to_stockpile = { type = convoy_1 amount = 2000 producer = USA }
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					tag = USA
				}
				set_variable = { global.USA_cairoC_terms_responded = 0 }
				set_variable = { global.USA_cairoC_terms_agreed = 0 }
				if = {
					limit = {
						has_global_flag = CHI_atten_cairoC
					}
					event_target:KMT_central_gov_tag = {
						country_event = { id = cairoC.5 }
					}
				}
				if = {
					limit = {
						has_global_flag = ENG_atten_cairoC
					}
					ENG = {
						country_event = { id = cairoC.5 }
					}
				}
			}
		}
	}
	
	option = {
		name = cairoC.5.a
		log = "[Root.GetName]: agreed on cairoC"
		ai_chance = {
			factor = 100
			modifier = {
				tag = ENG
				factor = 85
			}
		}
		if = {
			limit = {
				tag = ENG
			}
			set_global_flag = ENG_agree_cairoC_term
		}
		if = {
			limit = {
				tag = event_target:KMT_central_gov_tag
			}
			set_global_flag = CHI_agree_cairoC_term
		}
		if = {
			limit = {
				tag = USA
			}
			set_global_flag = USA_agree_cairoC_term
		}
		add_to_variable = { global.USA_cairoC_terms_responded = 1 }
		add_to_variable = { global.USA_cairoC_terms_agreed = 1 }
		set_country_flag = agreed_on_cairoC_terms
		hidden_effect = {
			if = {
				limit = {
					check_variable = { global.USA_cairoC_terms_responded > 2 }
				}
				news_event = { id = cairoC.7 hours = 1}
			}
		}
	}
	
	option = {
		name = cairoC.5.b
		ai_chance = {
			factor = 0
			modifier = {
				tag = ENG
				factor = 15
			}
		}
		if = {
			limit = {
				tag = ENG
			}
			set_global_flag = ENG_disagree_cairoC_term
		}
		if = {
			limit = {
				tag = event_target:KMT_central_gov_tag
			}
			set_global_flag = CHI_disagree_cairoC_term
		}
		if = {
			limit = {
				tag = USA
			}
			set_global_flag = USA_disagree_cairoC_term
		}
		add_to_variable = { global.USA_cairoC_terms_responded = 1 }
		hidden_effect = {
			if = {
				limit = {
					check_variable = { global.USA_cairoC_terms_responded > 2 }
					has_global_flag = {
						flag = CairoC_clicked
						value > 2
					}
				}
				news_event = { id = cairoC.7 hours = 1}
			}
		}
	}
}

#cairoC news
news_event = {
	id = cairoC.6
	title = cairoC.6.t
	desc = {
		text = cairoC.6.d_fail
		trigger = {
			check_variable = { global.USA_cairoC_terms_agreed < 2 }
		}
	}
	desc = {
		text = cairoC.6.d_noUS
		trigger = {
			check_variable = { global.USA_cairoC_terms_agreed = 2 }
			NOT = {
				has_global_flag = USA_agree_cairoC_term
			}
		}
	}
	desc = {
		text = cairoC.6.d_noBR
		trigger = {
			check_variable = { global.USA_cairoC_terms_agreed = 2 }
			has_global_flag = ENG_atten_cairoC
			NOT = {
				has_global_flag = ENG_agree_cairoC_term
			}
		}
	}
	desc = {
		text = cairoC.6.d_suc_2
		trigger = {
			check_variable = { global.USA_cairoC_terms_agreed = 2 }
			OR = {
				NOT = {
					has_global_flag = ENG_atten_cairoC
				}
				NOT = {
					has_global_flag = CHI_atten_cairoC
				}
			}
		}
	}
	desc = {
		text = cairoC.6.d_noCN
		trigger = {
			check_variable = { global.USA_cairoC_terms_agreed = 2 }
			has_global_flag = CHI_atten_cairoC
			NOT = {
				has_global_flag = CHI_agree_cairoC_term
			}
		}
	}
	desc = {
		text = cairoC.6.d_suc
		trigger = {
			check_variable = { global.USA_cairoC_terms_agreed > 2 }
		}
	}
	picture = GFX_cairoC

	is_triggered_only = yes
	
	major = yes
	
	immediate = {
		hidden_effect = {
			every_country = {
				limit = {
					has_country_flag = agreed_on_cairoC_terms
				}
				country_event = { id = cairoC.8 }
			}
			if = {
				limit = {
					check_variable = { global.USA_cairoC_terms_agreed > 1 }
					has_global_flag = CHI_atten_cairoC
				}
				set_global_flag = KMT_cairo_JAP_return_land_when_capitulate
			}
		}	
	}
				
	
	option = {
		name = cairoC.6.a
		trigger = {
			has_country_flag = agreed_on_cairoC_terms
		}
	}
	
	option = {
		name = cairoC.6.b
		trigger = {
			OR = {
				tag = JAP
				has_country_flag = disagreed_cairoC_terms
			}
		}
	}
	
	option = {
		name = cairoC.6.c
		trigger = {
			NOT = {
				has_country_flag = disagreed_cairoC_terms
				has_country_flag = agreed_on_cairoC_terms
			}
		}
	}
}

#cairoC location
news_event = {
	id = cairoC.7
	hidden = yes

	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				907 = {
					controller = {
						OR = {
							tag = ENG
							is_puppet_of = ENG
							is_in_faction_with = ENG
						}
					}
				}
				has_global_flag = ENG_agree_cairoC_term
			}
			907 = {
				save_global_event_target_as = CairoC_venue
			}
			else = {
				if = {
					limit = {
						has_global_flag = USA_agree_cairoC_term
						USA = {
							capital_scope = {
								NOT = {
									controller = {
										has_war_with = USA
									}
								}
							}
						}
					}
					USA = {
						capital_scope = {
							save_global_event_target_as = CairoC_venue
						}
					}
					else = {
						random_state = {
							limit = {
								owner = {
									has_country_flag = agreed_on_cairoC_terms
								}
								controller = {
									has_country_flag = agreed_on_cairoC_terms
								}
							}
							save_global_event_target_as = CairoC_venue
						}
					}
				}
			}
		}
		news_event = { id = cairoC.6 }
	}

	option = {
	}
}

#cairoC result
country_event = {
	id = cairoC.8
	title = cairoC.6.t
	desc = {
		trigger = {
			OR = {
				has_global_flag = ENG_agree_cairoC_term
				has_global_flag = USA_agree_cairoC_term
				has_global_flag = CHI_agree_cairoC_term
			}
		}
		text = cairoC.8.d
	}
	desc = {
		trigger = {
			NOT = {
				has_global_flag = ENG_agree_cairoC_term
				has_global_flag = USA_agree_cairoC_term
				has_global_flag = CHI_agree_cairoC_term
			}
		}
		text = cairoC.8.d_no
	}
	
	picture = GFX_report_event_generic_sign_treaty1

	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				has_global_flag = CHI_agree_cairoC_term
				ROOT = { tag = event_target:KMT_central_gov_tag }
			}
			event_target:KMT_central_gov_tag = {
				if = {
					limit = {
						has_global_flag = ENG_agree_cairoC_term
					}
					add_political_power = 300
				}
				if = {
					limit = {
						has_global_flag = USA_agree_cairoC_term
					}
					add_political_power = 200
				}
				if = {
					limit = {
						OR = {
							has_global_flag = USA_agree_cairoC_term
							has_global_flag = ENG_agree_cairoC_term
						}
					}
					every_country = {
						limit = {
							OR = {
								is_in_faction_with = USA
								is_in_faction_with = ENG
							}
						}
						diplomatic_relation = { country = ROOT relation = military_access active = yes }
						diplomatic_relation = { country = ROOT relation = non_aggression_pact active = yes }
						ROOT = { 
							diplomatic_relation = { country = PREV relation = military_access active = yes }
							diplomatic_relation = { country = PREV relation = non_aggression_pact active = yes }
						}
					}
					#effect_tooltip = { dismantle_faction = yes }
					#every_country = {
					#	limit = { is_in_faction_with = ROOT }
					#	set_country_flag = KMT_cuf_member
					#	random_country = {
					#		limit = {
					#			OR = {
					#				is_in_faction_with = ENG
					#				is_in_faction_with = USA
					#			}
					#			is_faction_leader = yes
					#		}
					#		add_to_faction = PREV
					#	}
					#}
					custom_effect_tooltip = KMT_no_seperate_peace_with_JAP
					set_country_flag = KMT_no_seperate_peace_with_JAP_flag
					add_equipment_to_stockpile = { type = convoy_1 amount = 2000 producer = USA }
					custom_effect_tooltip = KMT_war_with_axis_tt
					add_war_support = 0.3
					every_country = {
						limit = {
							OR = {
								has_war_with = ENG
								has_war_with = USA
							}
							is_subject = no
							is_in_faction = yes
						}
						every_country = {
							limit = {
								OR = {
									tag = event_target:KMT_central_gov_tag
									is_subject_of = event_target:KMT_central_gov_tag
									is_in_faction_with = event_target:KMT_central_gov_tag
								}
								NOT = { has_war_with = PREV }
							}
							declare_war_on = {
								target = PREV
								type = topple_government
							}
						}
					}
				}
			}
		}
		if = {
			limit = {
				has_global_flag = ENG_agree_cairoC_term
				ROOT = { tag = ENG }
			}
			ENG = {
				if = {
					limit = {
						has_global_flag = CHI_agree_cairoC_term
					}
					add_political_power = -50
				}
				if = {
					limit = {
						has_global_flag = USA_agree_cairoC_term
					}
					add_tech_bonus = {
						uses = 2
						bonus = 2
						category = naval_equipment
					}
					add_equipment_to_stockpile = { type = convoy_1 amount = 1000 producer = ENG }
				}
			}
		}
		if = {
			limit = {
				has_global_flag = USA_agree_cairoC_term
				ROOT = { tag = USA }
			}
			USA = {
				if = {
					limit = {
						has_global_flag = CHI_agree_cairoC_term
					}
					add_political_power = -50
				}
				if = {
					limit = {
						has_global_flag = ENG_agree_cairoC_term
					}
					add_tech_bonus = {
						uses = 2
						bonus = 2
						category = naval_equipment
					}
					add_tech_bonus = {
						uses = 2
						bonus = 2
						category = tp_tech
					}
					add_equipment_to_stockpile = { type = convoy_1 amount = 2000 producer = USA }
				}
			}
		}
	}

	option = {
		name = cairoC.6.a
	}
}